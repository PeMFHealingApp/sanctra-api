<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no"
  />
  <title>Sanctra – Sacred Sites Player</title>

  <!-- Quicksand font -->
  <link
    href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap"
    rel="stylesheet"
  />

  <style>
    :root{
      --bg:#1f1f1f;
      --card:#2b2b2b;
      --text:#e5e5e5;
      --sub:#bdbdbd;
      --gold:#bf9726;
      --line:#3a3a3a;
      --black:#0f0f0f;
    }
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:Quicksand,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    *{box-sizing:border-box}
    .container{max-width:960px;margin:0 auto;padding:0 16px 112px}
    .sticky{position:sticky;top:0;background:var(--bg);z-index:20;padding:12px 0 8px;border-bottom:1px solid transparent}
    .row{display:flex;gap:12px}
    .col{flex:1}
    label{display:block;font-size:12px;color:var(--sub);margin:0 0 6px}
    select{width:100%;background:var(--card);color:var(--text);border:1px solid var(--line);border-radius:12px;padding:10px 12px;appearance:none}
    .hero{margin-top:16px;border:1px solid var(--line);border-radius:16px;overflow:hidden}
    .play-layer{position:relative}
    .play-btn{position:absolute;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.25);border:0;cursor:pointer}
    .play-btn:hover{background:rgba(0,0,0,.35)}
    .ring{height:64px;width:64px;border-radius:999px;border:3px solid var(--text);display:grid;place-items:center;background:transparent}
    h1{margin:20px 0 4px;font-size:28px;letter-spacing:.2px}
    .muted{color:var(--sub)}
    .chips{display:flex;gap:8px;margin-top:12px}
    .chip{border:1px solid var(--line);border-radius:999px;padding:8px 12px;background:transparent;color:var(--text);font-size:14px}
    .chip--active{background:var(--gold);color:#111;font-weight:600}
    section{margin-top:20px}
    section h2{margin:0 0 8px;font-size:20px}
    section p{margin:0;color:var(--sub);line-height:1.6}
    .divider{margin-top:16px;border-top:1px solid var(--line)}
    .spinner{color:var(--sub);text-align:center;font-size:14px;padding:16px}
    .bar{position:fixed;left:0;right:0;bottom:0;background:var(--black);border-top:1px solid var(--line);z-index:40}
    .bar-inner{max-width:1100px;margin:0 auto;padding:8px 12px;display:flex;gap:12px;align-items:center}
    .thumb{height:36px;width:36px;border-radius:8px;object-fit:cover;border:1px solid var(--line)}
    .grow{min-width:0;flex:1}
    .row-mid{display:flex;gap:8px;align-items:center;margin-top:2px}
    input[type="range"]{width:100%}
    .icon-btn{height:32px;width:32px;border-radius:999px;border:1px solid var(--line);display:grid;place-items:center;background:transparent;color:var(--text);cursor:pointer}
    .icon-btn[disabled]{opacity:.4;cursor:not-allowed}
    .icon-btn--active{background:var(--gold);color:#111}
    .hidden{display:none}
    .img-skeleton{aspect-ratio:1/1;display:grid;place-items:center;background:var(--card)}
    @media (min-width:640px){
      h1{font-size:34px}
      .thumb{height:40px;width:40px}
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- React 18 UMD -->
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>

  <script>
  (() => {
    const { useEffect, useMemo, useRef, useState } = React;

    // ---------- Config ----------
    const qs = new URLSearchParams(location.search);
    const API_BASE = qs.get('api') || 'https://sanctra-api.onrender.com';
    const AUDIO_BASE = qs.get('audio') || ''; // optional, see audioFromSite()
    const DEFAULT_COUNTRY = 'Egypt';
    const MINUTES_CHOICES = [15, 35, 45];

    // Build audio URL policy – customize when your stream is ready
    function audioFromSite(site, minutes){
      if(!AUDIO_BASE) return null; // disables play until configured
      const u = new URL(AUDIO_BASE, location.origin);
      u.searchParams.set('site', site);
      u.searchParams.set('minutes', String(minutes));
      return u.toString();
    }

    // Utilities
    const cls = (...xs) => xs.filter(Boolean).join(' ');
    const Spinner = () => React.createElement('div', {className:'spinner'}, 'loading…');
    const fmt = (s) => {
      const mm = String(Math.floor(s/60)).padStart(2,'0');
      const ss = String(Math.floor(s%60)).padStart(2,'0');
      return `${mm}:${ss}`;
    };

    function useFetchJSON(url, enabled=true){
      const [data,setData] = useState(null);
      const [loading,setLoading] = useState(!!enabled);
      const [err,setErr] = useState(null);
      useEffect(()=>{
        let alive = true;
        if(!enabled || !url){ setLoading(false); return; }
        setLoading(true);
        fetch(url)
          .then(r => r.ok ? r.json() : Promise.reject(new Error(r.status)))
          .then(j => { if(alive){ setData(j); setErr(null);} })
          .catch(e => { if(alive) setErr(e); })
          .finally(()=> { if(alive) setLoading(false); });
        return ()=>{ alive=false; };
      }, [url,enabled]);
      return { data, loading, err };
    }

    function App(){
      // state
      const [countries, setCountries] = useState([]);
      const [country, setCountry] = useState(DEFAULT_COUNTRY);
      const [sites, setSites] = useState([]);
      const [site, setSite] = useState('');
      const [imgUrl, setImgUrl] = useState('');
      const [meta, setMeta] = useState(null);
      const [minutes, setMinutes] = useState(MINUTES_CHOICES[0]);
      const [looping, setLooping] = useState(false);
      const [barOpen, setBarOpen] = useState(false);
      const audioRef = useRef(null);
      const [progress, setProgress] = useState({ t:0, d:0 });

      // countries
      const { data: countriesResp, loading: loadingCountries } =
        useFetchJSON(`${API_BASE}/countries`, true);

      useEffect(()=>{
        if(countriesResp?.countries){
          setCountries(countriesResp.countries);
          // default to Egypt if it exists
          if(countriesResp.countries.includes(DEFAULT_COUNTRY)) {
            setCountry(DEFAULT_COUNTRY);
          } else if(countriesResp.countries.length){
            setCountry(countriesResp.countries[0]);
          }
        }
      }, [countriesResp]);

      // sites for the country
      const { data: sitesResp, loading: loadingSites } =
        useFetchJSON(country ? `${API_BASE}/sites-for-country?country=${encodeURIComponent(country)}` : null, !!country);

      useEffect(()=>{
        if(sitesResp?.sites){
          setSites(sitesResp.sites);
          // prefer a Giza Pyramid, else first
          const preferred = sitesResp.sites.find(s => /giza|pyramid/i.test(s)) || sitesResp.sites[0] || '';
          setSite(preferred);
        } else {
          setSites([]); setSite('');
        }
      }, [sitesResp]);

      // image + meta for the site
      const { data: imgResp, loading: loadingImg } =
        useFetchJSON(site ? `${API_BASE}/site-image?site=${encodeURIComponent(site)}` : null, !!site);
      const { data: metaResp, loading: loadingMeta } =
        useFetchJSON(site ? `${API_BASE}/site-info?site=${encodeURIComponent(site)}` : null, !!site);

      useEffect(()=>{ setImgUrl(imgResp?.image_url || ''); }, [imgResp]);
      useEffect(()=>{ if(metaResp) setMeta(metaResp); }, [metaResp]);

      // audio source
      const audioUrl = useMemo(()=> site ? audioFromSite(site, minutes) : null, [site, minutes]);

      useEffect(()=>{ if(audioRef.current) audioRef.current.loop = looping; }, [looping]);

      function stopAnyPageAudio(){
        // Pause other <audio> tags
        document.querySelectorAll('audio').forEach(el => { if(el!==audioRef.current) try{ el.pause(); } catch{} });
        // Ask host app to stop its playback
        try{ window.parent.postMessage({ type:'pemf_stop_all_audio' }, '*'); }catch{}
      }

      function onPlay(){
        stopAnyPageAudio();
        setBarOpen(true);
        audioRef.current?.play?.();
      }
      function onPause(){ audioRef.current?.pause?.(); }
      function onSeek(e){
        if(!audioRef.current) return;
        audioRef.current.currentTime = Number(e.target.value||0);
      }
      function onTime(){
        if(!audioRef.current) return;
        setProgress({ t: audioRef.current.currentTime||0, d: audioRef.current.duration||0 });
      }

      return (
        React.createElement(React.Fragment, null,
          React.createElement('div',{className:'container'},
            React.createElement('div',{className:'sticky'},
              React.createElement('div',{className:'row'},
                React.createElement('div',{className:'col'},
                  React.createElement('label',null,'Select Country'),
                  React.createElement('select',{
                      value: country,
                      onChange:e=>setCountry(e.target.value)
                    },
                    loadingCountries ? React.createElement('option',null,'loading…') : null,
                    countries.map(c=>React.createElement('option',{key:c,value:c},c))
                  )
                ),
                React.createElement('div',{className:'col'},
                  React.createElement('label',null,'Select Sacred Site'),
                  React.createElement('select',{
                      value: site,
                      onChange:e=>setSite(e.target.value)
                    },
                    loadingSites ? React.createElement('option',null,'loading…') : null,
                    sites.map(s=>React.createElement('option',{key:s,value:s},s))
                  )
                )
              )
            ),

            // Hero
            React.createElement('div',{className:'hero'},
              React.createElement('div',{className:'play-layer'},
                loadingImg
                  ? React.createElement('div',{className:'img-skeleton'}, React.createElement(Spinner))
                  : React.createElement('img',{src:imgUrl||'', alt:site, style:{width:'100%',height:'auto',display:'block',objectFit:'cover'}}),
                React.createElement('button',{
                    className:'play-btn',
                    onClick:onPlay,
                    disabled:!audioUrl,
                    title: audioUrl ? 'Play' : 'Audio not configured (?audio=...)'
                  },
                  React.createElement('div',{className:'ring'},
                    React.createElement('svg',{width:28,height:28,viewBox:'0 0 24 24',fill:'currentColor','aria-hidden':'true'},
                      React.createElement('path',{d:'M8 5v14l11-7z'})
                    )
                  )
                )
              )
            ),

            React.createElement('h1',null, site || '—'),
            React.createElement('p',{className:'muted'}, country || ''),

            React.createElement('div',{className:'chips'},
              MINUTES_CHOICES.map(m =>
                React.createElement('button',{
                  key:m,
                  className: cls('chip', m===minutes && 'chip--active'),
                  onClick: ()=>setMinutes(m)
                }, `${m} min`)
              )
            ),

            // Info sections
            !meta || loadingMeta
              ? React.createElement(Spinner)
              : React.createElement(React.Fragment,null,
                  React.createElement('section',null,
                    React.createElement('h2',null,'Country'),
                    React.createElement('p',null, meta.region || country || '—'),
                    React.createElement('div',{className:'divider'})
                  ),
                  React.createElement('section',null,
                    React.createElement('h2',null,'Site Information'),
                    React.createElement('p',null, meta.description || '—'),
                    React.createElement('div',{className:'divider'})
                  ),
                  React.createElement('section',null,
                    React.createElement('h2',null,'Site Benefits'),
                    React.createElement('p',null, meta.health_benefits || '—'),
                    React.createElement('div',{className:'divider'})
                  ),
                  React.createElement('section',null,
                    React.createElement('h2',null,'Who is this for'),
                    React.createElement('p',null, meta.who_for || '—'),
                    React.createElement('div',{className:'divider'})
                  ),
                  React.createElement('section',null,
                    React.createElement('h2',null,'Disclaimer'),
                    React.createElement('p',null, meta.disclaimer || '—'),
                    React.createElement('div',{className:'divider'})
                  )
                )
          ),

          // Bottom bar
          barOpen && React.createElement('div',{className:'bar'},
            React.createElement('div',{className:'bar-inner'},
              React.createElement('img',{src:imgUrl||'',alt:'thumb',className:'thumb'}),
              React.createElement('div',{className:'grow'},
                React.createElement('div',{className:'muted',style:{whiteSpace:'nowrap',overflow:'hidden',textOverflow:'ellipsis'}},
                  'Country: ', React.createElement('span',{style:{color:'var(--text)'}},country),
                  ' · Site: ', React.createElement('span',{style:{color:'var(--text)'}},site)
                ),
                React.createElement('div',{className:'row-mid'},
                  React.createElement('span',{className:'muted',style:{fontSize:12}}, fmt(progress.t)),
                  React.createElement('input',{
                    type:'range', min:0, max:Math.max(progress.d||0,0), step:1,
                    value: Math.min(progress.t||0, progress.d||0),
                    onChange: onSeek
                  }),
                  React.createElement('span',{className:'muted',style:{fontSize:12}}, fmt(progress.d||0))
                )
              ),

              React.createElement('button',{className:'icon-btn',onClick:onPlay,disabled:!audioUrl,title:'Play'},
                React.createElement('svg',{width:18,height:18,viewBox:'0 0 24 24',fill:'currentColor'},
                  React.createElement('path',{d:'M8 5v14l11-7z'})
                )
              ),
              React.createElement('button',{className:'icon-btn',onClick:onPause,title:'Pause'},
                React.createElement('svg',{width:18,height:18,viewBox:'0 0 24 24',fill:'currentColor'},
                  React.createElement('path',{d:'M6 19h4V5H6v14zm8-14v14h4V5h-4z'})
                )
              ),
              React.createElement('input',{
                type:'range', min:'0', max:'1', step:'0.01', title:'Volume',
                onChange:e=>{ if(audioRef.current) audioRef.current.volume = Number(e.target.value); }
              }),
              React.createElement('button',{
                className:cls('icon-btn', looping && 'icon-btn--active'),
                onClick:()=>setLooping(v=>!v), title: looping?'Looping':'Loop once'
              },
                React.createElement('svg',{width:18,height:18,viewBox:'0 0 24 24',fill:'currentColor'},
                  React.createElement('path',{d:'M7 7h8v4l5-5-5-5v4H6a5 5 0 00-5 5v3h2v-3a3 3 0 013-3zm10 10H9v-4l-5 5 5 5v-4h9a5 5 0 005-5v-3h-2v3a3 3 0 01-3 3z'})
                )
              ),
              React.createElement('button',{className:'icon-btn',onClick:()=>setBarOpen(false),title:'Close'},
                React.createElement('svg',{width:18,height:18,viewBox:'0 0 24 24',fill:'currentColor'},
                  React.createElement('path',{d:'M18.3 5.71L12 12l6.3 6.29-1.41 1.42L10.59 13.41 4.29 19.71 2.88 18.3 9.17 12 2.88 5.71 4.29 4.29 10.59 10.59 16.89 4.29z'})
                )
              ),
              // Hidden <audio> element
              React.createElement('audio',{
                ref:audioRef, src: audioUrl || undefined, loop: looping, preload:'none',
                onTimeUpdate:onTime, onLoadedMetadata:onTime, onPlay:()=>setBarOpen(true)
              })
            )
          )
        )
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(React.createElement(App));
  })();
  </script>
</body>
</html>
